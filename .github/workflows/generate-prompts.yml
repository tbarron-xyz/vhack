name: Generate Prompts

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - build-action

jobs:
  generate:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1

    - name: Build vulnerability-scanner-rs
      run: |
        cd vulnerability-scanner-rs
        cargo build --release

    - name: Generate prompts
      run: |
        cd vulnerability-scanner-rs
        ./target/release/vulnerability-scanner-rs --generate-prompts --concurrency 4
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

    - name: Upload prompts.csv as artifact
      uses: actions/upload-artifact@v4
      with:
        name: generated-prompts
        path: vulnerability-scanner-rs/prompts.csv

    - name: Upload testcategories.md as artifact
      uses: actions/upload-artifact@v4
      with:
        name: test-categories
        path: vulnerability-scanner-rs/testcategories.md